%define srcname    argus-clients
%define ver     @PACKAGE_VERSION@
%if %{?rel:0}%{!?rel:1}
%define rel     @PACKAGE_RELEASE@
%endif
%if %{?srcext:0}%{!?srcext:1}
%define srcext .gz
%endif
Summary: Gargoyle Client Software
Name: argus-clients%{?_workstation:-workstation}
Version: %ver
Release: %rel%{dist}.3
License: Proprietary
Group: Applications/Internet
Source: %{srcname}-%{version}.%{rel}.tar%{srcext}
URL: http://qosient.com/argus
Buildroot: %{_tmppath}/%{srcname}-%{ver}-root
%{?systemd_requires}
BuildRequires: systemd
BuildRequires: ncurses-devel, readline-devel, zlib-devel
BuildRequires: pcre-devel, GeoIP-devel
BuildRequires: mariadb-devel
BuildRequires: cyrus-sasl-devel
BuildRequires: libuuid-devel
Requires: cyrus-sasl
Conflicts: argus-clients-misc < 5.0-3.1%{dist}.1

%description
Argus Clients contains a number of programs that process Argus data.
Copyright: 2000-2022 QoSient, LLC

%define argusdir        /usr
%define argusman        /usr/share/man
%define argusdocs       /usr/share/doc/%{srcname}-%{ver}

%define argusbin        %{argusdir}/bin
%define argussbin       %{argusdir}/sbin
%define argusdata       %{argusdir}/argus

%prep
%setup -n %{srcname}-%{ver}.%{rel}
%build
%configure --with-sasl %{?_workstation:--without-mysql}
make EXTRA_CFLAGS="-ggdb" %{?_workstation:WORKSTATION_BUILD=1}

%install
rm -rf $RPM_BUILD_ROOT
make DESTDIR="$RPM_BUILD_ROOT" %{?_workstation:WORKSTATION_BUILD=1} install
cp -av support $RPM_BUILD_ROOT/%{argusdocs}/

%if 0%{!?_workstation:1}
%post
mkdir -p /home/argus
%systemd_post radium.service
%systemd_post rastream.service
ln -s %{argusbin}/rastream %{argusbin}/rasplit
ln -s /etc/pam.d/system-auth /etc/pam.d/radium

%preun
%systemd_preun radium.service
%systemd_preun rastream.service

%postun
%systemd_postun_with_restart radium.service
%systemd_postun_with_restart rastream.service
rm -f %{argusbin}/rasplit
rm -f /etc/pam.d/radium
%else
%post
ln -s %{argusbin}/rastream %{argusbin}/rasplit
%postun
rm -f %{argusbin}/rasplit
%endif


%files
%defattr(-,root,root)

%{argusdata}

%doc %{argusdocs}

%{argusman}/man1/ra.1.gz
%{argusman}/man1/rabins.1.gz
%{argusman}/man1/racluster.1.gz
%{argusman}/man1/racount.1.gz
%{argusman}/man5/radium.conf.5.gz
%{argusman}/man8/radium.8.gz
%{argusman}/man1/ranonymize.1.gz
%{argusman}/man1/rasort.1.gz
%{argusman}/man1/rasplit.1.gz
%{argusman}/man1/rastream.1.gz

%{argusbin}/ra
%{argusbin}/rabins
%{argusbin}/racluster
%{argusbin}/racount
%{argusbin}/ranonymize
%{argusbin}/rasort
%{argusbin}/rastream
%ghost %{argusbin}/rasplit
%{argussbin}/radium
%config /etc/ra.conf
%config /etc/radium.conf
%if 0%{!?_workstation:1}
%config /etc/sasl2/radium.conf
%config /usr/argus/ralabel.country.conf
%ghost /etc/pam.d/radium
%{argussbin}/radium-setup
%{_unitdir}/radium.service
%{_unitdir}/rastream.service
%config /etc/sysconfig/radium
%config /etc/sysconfig/rastream
%{argussbin}/rastream-process
%else
%{_unitdir}/rasplit.service
%config /etc/sysconfig/rasplit
%endif

%ghost /home/argus

%package examples
Summary: Argus Client Example Programs
Group: Applications/Internet
Requires: cyrus-sasl

%description examples
argus-client-examples contains the compiled examples from the source
distribution.

%files examples
%defattr(-,root,root)
%{argusbin}/*
%exclude %{argusbin}/ra
%exclude %{argusbin}/rabins
%exclude %{argusbin}/racluster
%exclude %{argusbin}/racount
%exclude %{argusbin}/ranonymize
%exclude %{argusbin}/rasort
%exclude %{argusbin}/rastream
%exclude %{argusbin}/ragraph
%exclude %{argusbin}/rasql*
%exclude %{argusbin}/radhcp
%exclude %{argusbin}/radns
%exclude %{argusbin}/radnsdb
%{argusman}
%exclude %{argusman}/man1/ra.1.gz
%exclude %{argusman}/man1/rabins.1.gz
%exclude %{argusman}/man1/racluster.1.gz
%exclude %{argusman}/man1/racount.1.gz
%exclude %{argusman}/man5/radium.conf.5.gz
%exclude %{argusman}/man8/radium.8.gz
%exclude %{argusman}/man1/ranonymize.1.gz
%exclude %{argusman}/man1/rasort.1.gz
%exclude %{argusman}/man1/rasplit.1.gz
%exclude %{argusman}/man1/rastream.1.gz
%exclude %{argusman}/man1/ragraph.1.gz
%exclude %{argusman}/man1/rasql.1.gz

%package dhcp
Summary: Argus DHCP-tracking Client Software
Group: Applications/Internet
Conflicts: argus-clients-examples <= 5.0-3.0%{dist}.22
%if 0%{!?_workstation:1}
Requires: argus-clients-sql
%endif

%description dhcp
Argus DHCP-tracking Client Software

%files dhcp
%defattr(-,root,root)
%{_sbindir}/radhcp-setup
%{_unitdir}/radhcp.service
%{_bindir}/radhcp
%if 0%{!?_workstation:1}
%{_sbindir}/radhcp-nightly
%{_unitdir}/radhcp-nightly.timer
%{_unitdir}/radhcp-nightly.service
%{_datarootdir}/argus-clients/rasqlinsert.dhcp
%endif

%post dhcp
%systemd_post radhcp.service

%preun dhcp
%systemd_preun radhcp.service

%postun dhcp
%systemd_postun_with_restart radhcp.service




%package dns
Summary: Argus DNS-tracking Client Software
Group: Applications/Internet
Conflicts: argus-clients-examples <= 5.0-3.0%{dist}.25

%description dns
Argus DNS-tracking Client Software

%files dns
%defattr(-,root,root)
%{_bindir}/radns
%{_bindir}/radnsdb



%package devel
Summary: Argus Client Software Development Libraries
Group: Applications/Internet
Requires: GeoIP-devel = 1.5.0
Requires: zlib-devel
Requires: cyrus-sasl-devel

%description devel
Argus Clients contains a number of programs that process Argus data.
Copyright 2000-2016 QoSient, LLC

%files devel
%defattr(-,root,root)
%{_includedir}/argus
%{_libdir}/argus_client.a
%{_libdir}/argus_common.a
%{_libdir}/argus_parse.a
%{_libdir}/pkgconfig/argus-clients.pc

%package graph
Summary: Argus Client Software Graph Tool
Group: Applications/Internet
Requires: argus-clients%{?_workstation:-workstation}

%description graph
Tool to graph Argus data
Copyright 2000-2016 QoSient, LLC

%files graph
%defattr(-,root,root)
%{argusbin}/ragraph
%{argusman}/man1/ragraph.1.gz

%if 0%{!?_workstation:1}
%package sql
Summary: Argus Client Software SQL Tools
Group: Applications/Internet
Requires: argus-clients, mariadb-libs

%description sql
Tools to view modify Argus data in SQL databases
Copyright 2000-2016 QoSient, LLC

%files sql
%defattr(-,root,root)
%{argussbin}/rasqlinsert-setup
%{argusbin}/rasql*
%{argusman}/man1/rasql*
%{_unitdir}/rasqlinsert@.service
%{_datarootdir}/argus-clients/rasql*
%{_sysconfdir}/rastream.d/00rasqltimeindex
%dir %{_sysconfdir}/rastream.d
%endif

%changelog
* Tue May 02 2017 eric@qosient.com
- rebuilt

