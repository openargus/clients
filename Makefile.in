#
#  Argus Client Software. Tools to read, analyze and manage Argus data.
#  Copyright (c) 2000-2022 QoSient, LLC
#  All rights reserved.
# 
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2, or (at your option)
#  any later version.
# 
#  Gargoyle Client Software. Tools to read, analyze and manage Argus data.
#  Copyright (c) 2000-2017 QoSient, LLC
#  All rights reserved.
# 
#  THE ACCOMPANYING PROGRAM IS PROPRIETARY SOFTWARE OF QoSIENT, LLC,
#  AND CANNOT BE USED, DISTRIBUTED, COPIED OR MODIFIED WITHOUT
#  EXPRESS PERMISSION OF QoSIENT, LLC.
# 
#  QOSIENT, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS
#  SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
#  AND FITNESS, IN NO EVENT SHALL QOSIENT, LLC BE LIABLE FOR ANY
#  SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
#  WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER
#  IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,
#  ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF
#  THIS SOFTWARE.
# 
#

NOOP = $(SHELL) -c true
NOECHO = @

CC = @CC@

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

DEFS = @DEFS@
LIBS = @LIBS@
WRAPLIBS = @WRAPLIBS@
VERSION = @PACKAGE_VERSION@.@PACKAGE_RELEASE@

CFLAGS = -g $(EXTRA_CFLAGS)
LDFLAGS = -g

prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
perlextlib = @PERL_EXT_LIB@

srcdir = @srcdir@
incdir = @prefix@/include
docdir = @datadir@/doc/argus-clients-5.0

#### End of system configuration section. ####

SHELL = /bin/sh

DIRS = @DIRS@
INSTDIRS = @DIRS@ ./include ./pkg
OSXPACKAGE_INSTDIRS = ./clients ./examples/ratop

DISTFILES = AUTHORS CHANGES CREDITS ChangeLog INSTALL MANIFEST Makefile.in README VERSION \
	include lib man support aclocal.m4 acsite.m4 config configure configure.ac .threads \
	bin clients examples common debian pkg perllib

.c.o:
	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<

.PHONY: install installdirs install-perl uninstall-perl

all: force
	@set -e ; for i in  $(DIRS) ; do \
		if [ -d $$i ] ; then \
		echo "making in $$i"; \
		(cd $$i > /dev/null; $(MAKE));\
		fi; \
	done

.PHONY: all uninstall uninstall-perl

clients: common
examples: common
include: common

install: install-perl force installdirs
	@for i in  $(INSTDIRS) ; do \
		if [ -d $$i ] ; then \
		echo "making in $$i"; \
		(cd $$i > /dev/null; $(MAKE) install); \
		fi; \
	done
	$(INSTALL) -m 0644 $(srcdir)/support/Config/rarc $(DESTDIR)$(prefix)/argus/rarc
	$(INSTALL) -m 0644 $(srcdir)/support/Config/delegated-ipv4-latest $(DESTDIR)$(prefix)/argus/delegated-ipv4-latest
	$(INSTALL) -m 0644 $(srcdir)/support/Config/wireshark.manuf.txt $(DESTDIR)$(prefix)/argus/wireshark.manuf.txt
	$(INSTALL) -m 0644 $(srcdir)/support/Config/std.sig $(DESTDIR)@datarootdir@/argus-clients/std.sig
	$(INSTALL) -m 0755 $(srcdir)/bin/argusclientbug $(DESTDIR)@bindir@/argusclientbug
	[ -d $(DESTDIR)@mandir@ ] || \
		(mkdir -p $(DESTDIR)@mandir@; chmod 755 $(DESTDIR)@mandir@)
	[ -d $(DESTDIR)@mandir@/man1 ] || \
		(mkdir -p $(DESTDIR)@mandir@/man1; chmod 755 $(DESTDIR)@mandir@/man1)
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ra.1 \
		$(DESTDIR)@mandir@/man1/ra.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rabins.1 \
		$(DESTDIR)@mandir@/man1/rabins.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/racluster.1 \
		$(DESTDIR)@mandir@/man1/racluster.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/raconvert.1 \
		$(DESTDIR)@mandir@/man1/raconvert.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/racount.1 \
		$(DESTDIR)@mandir@/man1/racount.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/radecode.1 \
		$(DESTDIR)@mandir@/man1/radecode.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/radump.1 \
		$(DESTDIR)@mandir@/man1/radump.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/raevent.1 \
		$(DESTDIR)@mandir@/man1/raevent.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rafilteraddr.1 \
		$(DESTDIR)@mandir@/man1/rafilteraddr.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ragen.1 \
		$(DESTDIR)@mandir@/man1/ragen.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ragraph.1 \
		$(DESTDIR)@mandir@/man1/ragraph.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ragrep.1 \
		$(DESTDIR)@mandir@/man1/ragrep.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rahisto.1 \
		$(DESTDIR)@mandir@/man1/rahisto.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ralabel.1 \
		$(DESTDIR)@mandir@/man1/ralabel.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ranonymize.1 \
		$(DESTDIR)@mandir@/man1/ranonymize.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rapath.1 \
		$(DESTDIR)@mandir@/man1/rapath.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rapolicy.1 \
		$(DESTDIR)@mandir@/man1/rapolicy.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rasort.1 \
		$(DESTDIR)@mandir@/man1/rasort.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ramanage.1 \
		$(DESTDIR)@mandir@/man1/ramanage.1
ifndef WORKSTATION_BUILD
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rasql.1 \
		$(DESTDIR)@mandir@/man1/rasql.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rasqlcheckconf.1 \
		$(DESTDIR)@mandir@/man1/rasqlcheckconf.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rasqlinsert.1 \
		$(DESTDIR)@mandir@/man1/rasqlinsert.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rasqltimeindex.1 \
		$(DESTDIR)@mandir@/man1/rasqltimeindex.1
endif
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rastream.1 \
		$(DESTDIR)@mandir@/man1/rastream.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/rastrip.1 \
		$(DESTDIR)@mandir@/man1/rastrip.1
	$(INSTALL) -m 0644 $(srcdir)/man/man1/ratop.1 \
		$(DESTDIR)@mandir@/man1/ratop.1
	[ -d $(DESTDIR)@mandir@/man5 ] || \
		(mkdir -p $(DESTDIR)@mandir@/man5; chmod 755 $(DESTDIR)@mandir@/man5)
	[ -d $(DESTDIR)@mandir@/man8 ] || \
		(mkdir -p $(DESTDIR)@mandir@/man8; chmod 755 $(DESTDIR)@mandir@/man8)
	$(INSTALL) -m 0644 $(srcdir)/man/man5/rarc.5 \
		$(DESTDIR)@mandir@/man5/rarc.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/racluster.5 \
		$(DESTDIR)@mandir@/man5/racluster.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/racolor.conf.5 \
		$(DESTDIR)@mandir@/man5/racolor.conf.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/ralabel.conf.5 \
		$(DESTDIR)@mandir@/man5/ralabel.conf.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/radium.conf.5 \
		$(DESTDIR)@mandir@/man5/radium.conf.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/ranonymize.5 \
		$(DESTDIR)@mandir@/man5/ranonymize.5
	$(INSTALL) -m 0644 $(srcdir)/man/man5/ramanage.conf.5 \
		$(DESTDIR)@mandir@/man5/ramanage.conf.5
	$(INSTALL) -m 0644 $(srcdir)/man/man8/radium.8 \
		$(DESTDIR)@mandir@/man8/radium.8
	$(INSTALL) -m 0644 $(srcdir)/man/man8/ragen.8 \
		$(DESTDIR)@mandir@/man8/ragen.8

	[ -d $(DESTDIR)@prefix@ ] || \
		(mkdir -p $(DESTDIR)@prefix@; chmod 755 $(DESTDIR)@prefix@)
	[ -d $(DESTDIR)$(docdir) ] || \
		(mkdir -p $(DESTDIR)$(docdir); chmod 755 $(DESTDIR)$(docdir))
	$(INSTALL) -m 0644 $(srcdir)/README $(DESTDIR)$(docdir)

install-perl:
ifndef WORKSTATION_BUILD
	@set -e ; \
	mkdir -p $(DESTDIR)$(perlextlib)/qosient ; \
	$(INSTALL) -m 0644 $(srcdir)/lib/perl5/qosient/util.pm \
	           $(DESTDIR)$(perlextlib)/qosient/util.pm
endif

uninstall: uninstall-perl
	@for i in  $(INSTDIRS) ; do \
		if [ -d $$i ] ; then \
			echo "making in $$i"; \
			(cd $$i > /dev/null; $(MAKE) uninstall); \
		fi; \
	done
	rm -f $(DESTDIR)@bindir@/argusclientbug
	rm -f $(DESTDIR)@mandir@/man1/ra.1
	rm -f $(DESTDIR)@mandir@/man1/rabins.1
	rm -f $(DESTDIR)@mandir@/man1/racluster.1
	rm -f $(DESTDIR)@mandir@/man1/raconvert.1
	rm -f $(DESTDIR)@mandir@/man1/racount.1
	rm -f $(DESTDIR)@mandir@/man1/radecode.1
	rm -f $(DESTDIR)@mandir@/man1/radump.1
	rm -f $(DESTDIR)@mandir@/man1/raevent.1
	rm -f $(DESTDIR)@mandir@/man1/rafilteraddr.1
	rm -f $(DESTDIR)@mandir@/man1/ragen.1
	rm -f $(DESTDIR)@mandir@/man1/ragraph.1
	rm -f $(DESTDIR)@mandir@/man1/ragrep.1
	rm -f $(DESTDIR)@mandir@/man1/rahisto.1
	rm -f $(DESTDIR)@mandir@/man1/ralabel.1
	rm -f $(DESTDIR)@mandir@/man1/ranonymize.1
	rm -f $(DESTDIR)@mandir@/man1/rapath.1
	rm -f $(DESTDIR)@mandir@/man1/rapolicy.1
	rm -f $(DESTDIR)@mandir@/man1/rasort.1
	rm -f $(DESTDIR)@mandir@/man1/rasql.1
	rm -f $(DESTDIR)@mandir@/man1/rasqlcheckconf.1
	rm -f $(DESTDIR)@mandir@/man1/rasqlinsert.1
	rm -f $(DESTDIR)@mandir@/man1/rasqltimeindex.1
	rm -f $(DESTDIR)@mandir@/man1/rastream.1
	rm -f $(DESTDIR)@mandir@/man1/rastrip.1
	rm -f $(DESTDIR)@mandir@/man1/ratop.1
	rm -f $(DESTDIR)@mandir@/man5/rarc.5
	rm -f $(DESTDIR)@mandir@/man5/racluster.5
	rm -f $(DESTDIR)@mandir@/man5/ralabel.conf.5
	rm -f $(DESTDIR)@mandir@/man5/radium.conf.5
	rm -f $(DESTDIR)@mandir@/man5/ranonymize.5
	rm -f $(DESTDIR)@mandir@/man5/racolor.conf.5
	rm -f $(DESTDIR)@mandir@/man8/radium.8
	rm -f $(DESTDIR)@mandir@/man8/ragen.8
	rm -rf $(DESTDIR)$(docdir)
	rm -rf $(DESTDIR)$(prefix)/argus
	rm -f $(DESTDIR)@datarootdir@/argus-clients/std.sig

uninstall-perl:
ifndef WORKSTATION_BUILD
	rm -f $(DESTDIR)$(perlextlib)/qosient/util.pm
endif

installdirs:
	${srcdir}/config/mkinstalldirs \
	  $(DESTDIR)@sbindir@ \
	  $(DESTDIR)@bindir@ \
	  $(DESTDIR)@infodir@ \
          $(DESTDIR)$(prefix)/argus \
	  $(DESTDIR)@datarootdir@/argus-clients

# build with OSXSIGN="--sign "Developer ID Installer" to generate
# signed package
osxpackage:
	( \
        $(MAKE) install DESTDIR=`pwd`/pkg/osx/BUILDROOT/Contents/MacOS \
                        INSTDIRS="$(OSXPACKAGE_INSTDIRS)" && \
        ( find pkg/osx/BUILDROOT/Contents/MacOS -type f | xargs file \
           | awk -F: '/Mach-O.*executable/{print $$1}' \
           | xargs strip ) && \
        cp -f -L -R pkg/osx/osx-pkg/* pkg/osx/BUILDROOT/  && \
        codesign -vvvv -s "Developer ID Application: Carter Bullard" --timestamp --options runtime pkg/osx/BUILDROOT/Contents/MacOS/usr/local/sbin/radium && \
        codesign -vvvv -s "Developer ID Application: Carter Bullard" --timestamp --options runtime pkg/osx/BUILDROOT/Contents/MacOS/usr/local/bin/ra* && \
        pkgbuild --root pkg/osx/BUILDROOT/Contents/MacOS \
	         --identifier com.qosient.argus-clients \
	         --version $(VERSION) \
	         --ownership recommended \
	         --scripts pkg/osx/scripts pkg/osx/output.pkg && \
	productbuild --distribution pkg/osx/distribution.xml \
	             --resources pkg/osx/resources \
	             --package-path pkg/osx \
	             --version $(VERSION) \
	             $(OSXSIGN) \
	             pkg/osx/argus-clients-$(VERSION).pkg && \
	rm -f pkg/osx/output.pkg \
	)

win7package:
	( \
	$(MAKE) install DESTDIR=`pwd`/pkg/win7/BUILDROOT \
	                INSTDIRS="$(OSXPACKAGE_INSTDIRS)" && \
	( find pkg/win7/BUILDROOT -type f | xargs file \
	   | awk -F: '/PE32 executable/{print $$1}' \
	   | xargs strip ) && \
	$(MAKE) -C pkg/win7 \
	)


Makefile: Makefile.in config.status
	$(SHELL) config.status

config.status: configure
	$(srcdir)/configure --no-create

TAGS: $(SRCS)
	etags $(SRCS)

.PHONY: clean mostlyclean distclean realclean dist

clean: force
	rm -f config.log
	rm -f pkg/osx/*.pkg
	@for i in $(DIRS) ; do \
		if [ -d $$i ] ; then \
		(cd $$i > /dev/null; $(MAKE) clean ); \
		fi; \
	done

mostlyclean: clean

distclean: clean
	rm -f config.*
	rm -f TAGS
	rm -f lib/*.a
	rm -f bin/ra*
	rm -f Makefile
	@for i in $(DIRS) ; do \
		if [ -d $$i ] ; then \
		(cd $$i > /dev/null; $(MAKE) distclean); \
		fi; \
	done

clobber realclean: force
	rm -f TAGS
	rm -f lib/*.a
	rm -f include/argus_config.h
	rm -f include/tm.h
	rm -f bin/ra*
	rm -f pkg/osx/*.pkg
	rm -rf pkg/osx/BUILDROOT/
	rm -rf log

	@for i in $(DIRS) ; do \
		if [ -d $$i ] ; then \
		(cd $$i > /dev/null; $(MAKE) distclean); \
		fi; \
	done
	rm -f ./Makefile config.*

dist: $(DISTFILES) distclean
	echo argus-clients-`cat VERSION` > .fname
	rm -rf `cat .fname`
	mkdir `cat .fname`
	tar cf - $(DISTFILES) | (cd `cat .fname`; tar xpf -)
	ls -lR `cat .fname` | fgrep CVS: | sed 's/:$///' > exfile
	env COPYFILE_DISABLE=1 tar -X exfile -chzf `cat .fname`.tar.gz `cat .fname`
	rm -rf `cat .fname` .fname exfile

force:  /tmp
depend: $(GENSRC) force
	@for i in $(DIRS) ; do \
		if [ -d $$i ] ; then \
		(cd $$i > /dev/null; $(MAKE) depend ); \
		fi; \
	done

# Prevent GNU make v3 from overflowing arg limit on SysV.
.NOEXPORT:
