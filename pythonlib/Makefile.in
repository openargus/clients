#  Gargoyle Client Software. Tools to read, analyze and manage Argus data.
#  Copyright (c) 2018 QoSient, LLC
#  All rights reserved.
#
#  THE ACCOMPANYING PROGRAM IS PROPRIETARY SOFTWARE OF QoSIENT, LLC,
#  AND CANNOT BE USED, DISTRIBUTED, COPIED OR MODIFIED WITHOUT
#  EXPRESS PERMISSION OF QoSIENT, LLC.
#
#  QOSIENT, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS
#  SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
#  AND FITNESS, IN NO EVENT SHALL QOSIENT, LLC BE LIABLE FOR ANY
#  SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
#  WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER
#  IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION,
#  ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF
#  THIS SOFTWARE.

prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
pythonextlib = @PYTHON_EXT_LIB@
PYTHON = @V_PYTHON@
PYTHON_CFLAGS = $(shell $(PYTHON) -MConfig -e \
	'print join(" ", @Config{qw(ccflags optimize cccdlflags)}, \
	"-I$$Config{archlib}/CORE")' )
pythonvendorarch = $(shell $(PYTHON) -MConfig -e \ 'print $$Config{vendorarch}' )
pythonvendorarch_qosient = $(pythonvendorarch)/qosient/XS
pythonvendorarch_auto = $(pythonvendorarch)/auto/qosient/XS/util

# Pathname of directory to install the system binaries
SBINDIR = @sbindir@
# # Pathname of directory to install the system binaries
BINDIR = @bindir@
# Pathname of directory to install the include files
INCLDEST = @includedir@
# Pathname of directory to install the library
LIBDEST =  @libdir@
# Pathname of directory to install the man page
MANDEST = @mandir@
srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
CCOPT = @V_CCOPT@
INCLS = -I. -I../include -I../common @V_INCLS_EXAMPLES@ @MYSQL_INCLS@
DEFS = @DEFS@
COMPATLIB = @COMPATLIB@ @LIB_SASL@ @LIBS@ @V_THREADS@ @V_GEOIPDEP@ @V_PCRE@ @V_FTDEP@ @ZLIB@ @WRAPLIBS@

MYSQLLIB = @MYSQL_LDFLAGS@ 

# Standard CFLAGS
 CFLAGS = -fPIC $(CCOPT) $(INCLS) $(DEFS) $(EXTRA_CFLAGS)
INSTALL = @INSTALL@

ifeq ($(shell uname),Darwin)
 SOEXT = .dylib
else
 SOEXT = .so
endif

SRC = ../common/argus_parse_time.c argustime.c \
      argustime_wrap.c

.PHONY: install install-python uninstall uninstall-python TOP all depend

all: TOP

install: TOP install-python

TOP: util$(SOEXT) qosient/XS/util.pm

install-python: util$(SOEXT) qosient/XS/util.pm
	@set -e ; \
	mkdir -p $(DESTDIR)$(pythonvendorarch_qosient) ; \
	$(INSTALL) -m 0644 qosient/XS/util.pm \
	  $(DESTDIR)$(pythonvendorarch_qosient)/util.pm ; \
	mkdir -p $(DESTDIR)$(pythonvendorarch_auto) ; \
	$(INSTALL) -m 0755 util$(SOEXT) $(DESTDIR)$(pythonvendorarch_auto)/util$(SOEXT)

uninstall: uninstall-python

uninstall-python:
	rm -f $(DESTDIR)$(pythonvendorarch_qosient)/util.pm ; \
	rm -f $(DESTDIR)$(pythonvendorarch)/auto/qosient/XS/util.pm
	rm -f $(DESTDIR)$(pythonvendorarch_auto)/util$(SOEXT)

util$(SOEXT): argustime.o argustime_wrap.o argus_parse_time.o
	$(CC) $(CFLAGS) `$(PYTHON) -MConfig -e 'print $$Config{lddlflags}'` $^ -o $@
argus_parse_time.o: ../common/argus_parse_time.c
	$(CC) $(CFLAGS) -I../include -I../common $(PYTHON_CFLAGS) -c $(filter %.c, $^)
argustime.o: argustime.c
	$(CC) $(CFLAGS) -I../include $(PYTHON_CFLAGS) -c $(filter %.c, $^)
argustime_wrap.o: argustime_wrap.c
	$(CC) $(CFLAGS) -Wno-unused-variable -Wno-missing-prototypes \
	  -I../include $(PYTHON_CFLAGS) -c $(filter %.c, $^)

# multiple targets (left side of the colon) seems to confuse parallel make.
# create intermediate file swig.stamp instead.
argustime_wrap.c: swig.stamp
qosient/XS/util.pm: swig.stamp
swig.stamp: argustime.i
	mkdir -p qosient/XS
	swig -python3 $^
	mv util.pm qosient/XS
	touch swig.stamp

distclean: clean
	rm -f Makefile
clean:
	rm -f *.o argustime_wrap.c qosient/XS/util.pm util$(SOEXT) swig.stamp

depend: $(SRC)
	../bin/mkdep -c $(CC) $(CFLAGS) $(PYTHON_CFLAGS) $(SRC)

